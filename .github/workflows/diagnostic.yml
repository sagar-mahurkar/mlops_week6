name: GCP Auth Diagnostic
on:
  workflow_dispatch:

jobs:
  auth-check:
    runs-on: ubuntu-latest
    steps:
      # Checkout code
      - name: Checkout
        uses: actions/checkout@v4

      # Decode Base64 service account key
      - name: Decode service account key
        run: |
          echo "${{ secrets.GCP_CREDENTIALS_B64 }}" | base64 --decode > gcp-key.json
          echo "âœ… Service account key decoded to gcp-key.json"

      # Setup gcloud with decoded JSON
      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}
          service_account_key: gcp-key.json
          export_default_credentials: true

      # Verify gcloud authentication
      - name: Check gcloud auth
        run: |
          echo "ğŸ” Active account:"
          gcloud auth list
          echo "ğŸ” Project:"
          gcloud config list project

      # Test access to Artifact Registry
      - name: Test Artifact Registry access
        run: |
          echo "ğŸ” Listing Artifact Registry repositories:"
          gcloud artifacts repositories list --location=us-central1 --project=${{ secrets.GCP_PROJECT_ID }}

      # Test Docker authentication to Artifact Registry
      - name: Test Docker auth
        run: |
          gcloud auth configure-docker us-central1-docker.pkg.dev --quiet
          echo "ğŸ” Docker config:"
          cat ~/.docker/config.json | grep pkg.dev || echo "âŒ No pkg.dev entry found"
